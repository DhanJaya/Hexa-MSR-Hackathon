# 1. Find a fork with a merged PR
# 2. Get the time range of the commits
# 3. Analyse the commits of the PR using the time range

# https://github.com/pallets/flask/pull/4071
# Repo:
import json
import os
import shutil
import datetime
import dateutil.tz

from graal.backends.core.covuln import CoVuln

owner = 'dchevell'
repo = 'flask'
directory = '/tmp/' + repo


def remove_directories(directory):
    if os.path.exists(directory):
        shutil.rmtree(directory)
        print('Removed: ' + directory)
    if os.path.exists('/tmp/worktrees'):
        shutil.rmtree('/tmp/worktrees')
        print('Removed: /tmp/worktrees')


def run_graal_analysis():
    remove_directories(directory)
    from_date = datetime.datetime(2018, 10, 7, 00, 00, 00,
                                  tzinfo=dateutil.tz.tzutc())
    to_date = datetime.datetime(2018, 11, 6, 00, 00, 00,
                                tzinfo=dateutil.tz.tzutc())

    repo_uri = 'https://github.com/' + owner + '/' + repo
    co_vuln = CoVuln(uri=repo_uri, entrypoint='/tmp/worktrees/' + repo, git_path=directory)
    items = co_vuln.fetch(from_date=from_date, to_date=to_date)
    # with open("results.txt", "a") as results:
    #     results.write('https://github.com/pallets/flask/pull/4071')
    for commit in items:
        print(commit)

    remove_directories(directory)


run_graal_analysis()
